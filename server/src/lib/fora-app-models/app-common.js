(function() {
	"use strict";

	var services = require('fora-app-services'),
		DbConnector = require('fora-app-db-connector');

	var AppStats = require('./app-stats').AppStats;
	var AppSummary = require('./app-summary').AppSummary;

	var extendApp = function(App) {

		App.typeDefinition = {
			name: 'app',
			collection: 'apps',
			schema: {
				type: 'object',
				properties: {
					type: { type: 'string' },
					appType: { type: 'string' },
					version: { type: 'string' },
					versionMajor: { type: 'number' },
					versionMinor: { type: 'number' },
					versionRevision: { type: 'number' },
					name: { type: 'string' },
					description: { type: 'string' },
					stub: { type: 'string' },
					settings: { type: 'object' },
					access: {
						type: 'string',
						"enum": ['public', 'protected', 'private']
					},
					createdBy: { $ref: 'user-summary' },
					cover: { $ref: 'cover' },
					theme: { type: 'string' },
					cache: { type: 'object' },
					stats: { $ref: 'app-stats' }
				},
				required: ['type', 'appType', 'version', 'versionMajor', 'versionMinor', 'versionRevision',
					'name', 'description', 'stub', 'settings', 'access', 'createdBy', 'cache', 'stats']
			},
			indexes: [ { 'createdBy.id': 1 }, { 'stub': 1 }	],
			autoGenerated: {
				createdAt: { event: 'created' },
				updatedAt: { event: 'updated' }
			},
			links: {
				records: { type: 'record', field: 'appId' },
				info: { Type: 'app-info', field: 'appId' }
			},
			logging: {
				onInsert: 'NEW_APP'
			}
		};

		App.prototype.init = function() {
			if (!this.settings)
				this.settings = {};

			if (!this.cache)
				this.cache = {};

			if (!this.stats) {
				this.stats = new AppStats({
					records: 0,
					members: 0,
					lastRecord: 0
				});
			}
		};

		App.prototype.summarize = function*() {
			var typesService = services.get('typesService');
			return yield* typesService.constructModel(
				{
					id: DbConnector.getRowId(this),
					name: this.name,
					stub: this.stub,
					createdBy: this.createdBy
				},
				AppSummary
			);
		};

	};

	module.exports = {
		extendApp: extendApp
	};

})();
